# This workflow will test that the alembic migrations apply forwards and backwards.

name: Test Alembic Migrations

on:
  push:
  pull_request:
    types: [opened]
jobs:
  migrations:
    name: ‚öó Test Alembic Migrations
    runs-on: ubuntu-latest
    env:
      SQLALCHEMY_DATABASE_URI: postgresql://postgres:secret@localhost:5432
      POSTGRESQL_PASSWORD: secret
      SENDGRID_API_KEY: unused
      SHOPIFY_HMAC_SECRET: unused
      SECRET_KEY: unused
    steps:
    - uses: actions/checkout@v3
    - name: ‚ûï Install poetry
      uses: snok/install-poetry@v1
    - name: üêç Set up Python
      id: python
      uses: actions/setup-python@v4.6.0
      with:
        python-version: "3.11"
        cache: 'poetry'
    - name: üóÑ Set up PostgreSQL
      uses: danielweller-swp/postgresql-action@v2
      with:
        postgresql version: '14'  # See https://hub.docker.com/_/postgres for available versions
        postgresql user: postgres
        postgresql password: secret
    - name: üîß Install dependencies
      if: steps.python.outputs.cache-hit != 'true'
      run: |
        poetry install
    - name: ‚ö° Run forward migrations
      run: |
        poetry run alembic upgrade head
    - name: ‚ö° Run backwards migrations
      run: |
        poetry run alembic downgrade -10
    - name: ‚ö° Retest forward migrations
      run: |
        poetry run alembic upgrade head
