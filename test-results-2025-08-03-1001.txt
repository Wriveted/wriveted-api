DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 36ec4f3b-69b6-41b4-b74b-de1acbce1484 - Node: ask_genre
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.api.chat:chat.py:184 {'session_id': UUID('36ec4f3b-69b6-41b4-b74b-de1acbce1484'), 'input_type': 'text', 'event': 'Processed interaction', 'logger': 'app.api.chat', 'level': 'info'}
__________________________ test_update_session_state ___________________________

client = <starlette.testclient.TestClient object at 0x7bca50c77d50>
test_flow_with_nodes = {'content_id': '742ab84e-0ce9-4ace-8199-ddaf84de9787', 'flow_id': '6df58a66-18ac-4873-9818-60b04bc91bdd', 'question_content_id': '341ba639-5688-43f1-a2d4-e8546ca28b43'}

    def test_update_session_state(client, test_flow_with_nodes):
        """Test updating session state variables."""
        # Start session
        flow_id = test_flow_with_nodes["flow_id"]
        session_data = {
            "flow_id": flow_id,
            "user_id": None,
            "initial_state": {"user": {"name": "Eve"}},
        }

        start_response = client.post("v1/chat/start", json=session_data)
        session_token = start_response.json()["session_token"]

        # Update session state
        state_update = {
            "state_updates": {
                "reading_level": "advanced",
                "preferences": {"notifications": True, "theme": "dark"},
            }
        }

        response = client.patch(
            f"v1/chat/sessions/{session_token}/state", json=state_update
        )

>       assert response.status_code == status.HTTP_200_OK
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code
E        +  and   200 = status.HTTP_200_OK

app/tests/integration/test_chat_api.py:411: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
---------------------------- Captured stderr setup -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') name=Test Chat Flow
[info     ] Created content                [app.api.cms] content_id=UUID('742ab84e-0ce9-4ace-8199-ddaf84de9787') type=message
[info     ] Created flow node              [app.api.cms] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') node_id=welcome
[info     ] Created content                [app.api.cms] content_id=UUID('341ba639-5688-43f1-a2d4-e8546ca28b43') type=question
[info     ] Created flow node              [app.api.cms] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') node_id=ask_genre
[info     ] Created flow connection        [app.api.cms] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') source=welcome target=ask_genre
[info     ] Flow published                 [app.api.cms] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd')
------------------------------ Captured log setup ------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'name': 'Test Chat Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('742ab84e-0ce9-4ace-8199-ddaf84de9787'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'welcome', 'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('341ba639-5688-43f1-a2d4-e8546ca28b43'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'ask_genre', 'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:666 {'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'source': 'welcome', 'target': 'ask_genre', 'event': 'Created flow connection', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:443 {'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'event': 'Flow published', 'logger': 'app.api.cms', 'level': 'info'}
----------------------------- Captured stderr call -----------------------------
[info     ] Received flow event: session_started for session 58e27715-2043-444f-82ca-c081b14afc55 [app.services.event_listener]
[info     ] Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') session_id=UUID('58e27715-2043-444f-82ca-c081b14afc55') user_id=None
[info     ] Received flow event: node_changed for session 58e27715-2043-444f-82ca-c081b14afc55 [app.services.event_listener]
[info     ] Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome [app.services.event_listener]
[info     ] Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome [app.services.event_listener]
[info     ] Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome [app.services.event_listener]
[info     ] Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome [app.services.event_listener]
[info     ] Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome [app.services.event_listener]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('6df58a66-18ac-4873-9818-60b04bc91bdd') session_id=UUID('58e27715-2043-444f-82ca-c081b14afc55') user_id=None
[warning  ] The client sent invalid data!: [{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'reading_level': 'advanced', 'preferences': {'notifications': True, 'theme': 'dark'}}}}]

[{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'reading_level': 'advanced', 'preferences': {'notifications': True, 'theme': 'dark'}}}}] [app.main] request=URL('http://testserver/v1/chat/sessions/5PxB_aHmFWj6ZCFNB1tdy_h2rQd_2Al-psh_qYlSiMU/state')
------------------------------ Captured log call -------------------------------
INFO     app.services.event_listener:event_listener.py:126 Received flow event: session_started for session 58e27715-2043-444f-82ca-c081b14afc55
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('58e27715-2043-444f-82ca-c081b14afc55'), 'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'user_id': None, 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.services.event_listener:event_listener.py:126 Received flow event: node_changed for session 58e27715-2043-444f-82ca-c081b14afc55
INFO     app.services.event_listener:event_listener.py:244 Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session 58e27715-2043-444f-82ca-c081b14afc55 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: 58e27715-2043-444f-82ca-c081b14afc55 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.api.chat:chat.py:106 {'session_id': UUID('58e27715-2043-444f-82ca-c081b14afc55'), 'flow_id': UUID('6df58a66-18ac-4873-9818-60b04bc91bdd'), 'user_id': None, 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
WARNING  app.main:main.py:74 {'request': URL('http://testserver/v1/chat/sessions/5PxB_aHmFWj6ZCFNB1tdy_h2rQd_2Al-psh_qYlSiMU/state'), 'event': "The client sent invalid data!: [{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'reading_level': 'advanced', 'preferences': {'notifications': True, 'theme': 'dark'}}}}]\n\n[{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'reading_level': 'advanced', 'preferences': {'notifications': True, 'theme': 'dark'}}}}]", 'logger': 'app.main', 'level': 'warning'}
_____________ test_update_session_state_with_concurrency_conflict ______________

client = <starlette.testclient.TestClient object at 0x7bca50c77d50>
test_flow_with_nodes = {'content_id': 'f05daa46-78a1-4b74-a819-bc7a32243331', 'flow_id': '409b87e1-f0c2-46d0-9e1d-7aa64c30079f', 'question_content_id': 'b4f4fe5e-aaa2-49c6-8dbc-6da4f25edc6a'}

    def test_update_session_state_with_concurrency_conflict(client, test_flow_with_nodes):
        """Test session state update with concurrency conflict."""
        # Start session
        flow_id = test_flow_with_nodes["flow_id"]
        session_data = {"flow_id": flow_id, "user_id": None}

        start_response = client.post("v1/chat/start", json=session_data)
        session_token = start_response.json()["session_token"]

        # First update
        state_update1 = {"state_updates": {"counter": 1}, "expected_revision": 1}

        response1 = client.patch(
            f"v1/chat/sessions/{session_token}/state", json=state_update1
        )
>       assert response1.status_code == status.HTTP_200_OK
E       assert 422 == 200
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code
E        +  and   200 = status.HTTP_200_OK

app/tests/integration/test_chat_api.py:435: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
---------------------------- Captured stderr setup -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') name=Test Chat Flow
[info     ] Created content                [app.api.cms] content_id=UUID('f05daa46-78a1-4b74-a819-bc7a32243331') type=message
[info     ] Created flow node              [app.api.cms] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') node_id=welcome
[info     ] Created content                [app.api.cms] content_id=UUID('b4f4fe5e-aaa2-49c6-8dbc-6da4f25edc6a') type=question
[info     ] Created flow node              [app.api.cms] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') node_id=ask_genre
[info     ] Created flow connection        [app.api.cms] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') source=welcome target=ask_genre
[info     ] Flow published                 [app.api.cms] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f')
------------------------------ Captured log setup ------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'name': 'Test Chat Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('f05daa46-78a1-4b74-a819-bc7a32243331'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'welcome', 'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('b4f4fe5e-aaa2-49c6-8dbc-6da4f25edc6a'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'ask_genre', 'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:666 {'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'source': 'welcome', 'target': 'ask_genre', 'event': 'Created flow connection', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:443 {'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'event': 'Flow published', 'logger': 'app.api.cms', 'level': 'info'}
----------------------------- Captured stderr call -----------------------------
[info     ] Received flow event: session_started for session a9ba94bd-7db4-49ec-a923-1f60aa85c12f [app.services.event_listener]
[info     ] Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') session_id=UUID('a9ba94bd-7db4-49ec-a923-1f60aa85c12f') user_id=None
[info     ] Received flow event: node_changed for session a9ba94bd-7db4-49ec-a923-1f60aa85c12f [app.services.event_listener]
[info     ] Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome [app.services.event_listener]
[info     ] Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome [app.services.event_listener]
[info     ] Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome [app.services.event_listener]
[info     ] Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome [app.services.event_listener]
[info     ] Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome [app.services.event_listener]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f') session_id=UUID('a9ba94bd-7db4-49ec-a923-1f60aa85c12f') user_id=None
[warning  ] The client sent invalid data!: [{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'counter': 1}, 'expected_revision': 1}}]

[{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'counter': 1}, 'expected_revision': 1}}] [app.main] request=URL('http://testserver/v1/chat/sessions/z_Y-U-ywyFNxZnYWfENSxfpZ7Dc_j_-RnSWlPigLvBc/state')
------------------------------ Captured log call -------------------------------
INFO     app.services.event_listener:event_listener.py:126 Received flow event: session_started for session a9ba94bd-7db4-49ec-a923-1f60aa85c12f
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('a9ba94bd-7db4-49ec-a923-1f60aa85c12f'), 'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'user_id': None, 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.services.event_listener:event_listener.py:126 Received flow event: node_changed for session a9ba94bd-7db4-49ec-a923-1f60aa85c12f
INFO     app.services.event_listener:event_listener.py:244 Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session a9ba94bd-7db4-49ec-a923-1f60aa85c12f moved from None to welcome
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: a9ba94bd-7db4-49ec-a923-1f60aa85c12f - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.api.chat:chat.py:106 {'session_id': UUID('a9ba94bd-7db4-49ec-a923-1f60aa85c12f'), 'flow_id': UUID('409b87e1-f0c2-46d0-9e1d-7aa64c30079f'), 'user_id': None, 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
WARNING  app.main:main.py:74 {'request': URL('http://testserver/v1/chat/sessions/z_Y-U-ywyFNxZnYWfENSxfpZ7Dc_j_-RnSWlPigLvBc/state'), 'event': "The client sent invalid data!: [{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'counter': 1}, 'expected_revision': 1}}]\n\n[{'type': 'missing', 'loc': ('body', 'updates'), 'msg': 'Field required', 'input': {'state_updates': {'counter': 1}, 'expected_revision': 1}}]", 'logger': 'app.main', 'level': 'warning'}
_______________________________ test_end_session _______________________________

client = <starlette.testclient.TestClient object at 0x7bca50c77d50>
test_flow_with_nodes = {'content_id': '42f99f73-5ba0-42ee-9f44-ce4426c37bc5', 'flow_id': 'f953fa6e-c10e-433b-ac51-6980ad00fdb1', 'question_content_id': '66949b0a-642b-4b93-949e-1dbbaf0df534'}

    def test_end_session(client, test_flow_with_nodes):
        """Test ending a conversation session."""
        # Start session
        flow_id = test_flow_with_nodes["flow_id"]
        session_data = {"flow_id": flow_id, "user_id": None}

        start_response = client.post("v1/chat/start", json=session_data)
        session_token = start_response.json()["session_token"]

        # End session
        end_data = {"reason": "user_requested"}

        response = client.post(f"v1/chat/sessions/{session_token}/end", json=end_data)

        assert response.status_code == status.HTTP_200_OK
        data = response.json()

        assert "message" in data
>       assert "session_ended" in data["message"]
E       AssertionError: assert 'session_ended' in 'Session ended successfully'

app/tests/integration/test_chat_api.py:471: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
---------------------------- Captured stderr setup -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') name=Test Chat Flow
[info     ] Created content                [app.api.cms] content_id=UUID('42f99f73-5ba0-42ee-9f44-ce4426c37bc5') type=message
[info     ] Created flow node              [app.api.cms] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') node_id=welcome
[info     ] Created content                [app.api.cms] content_id=UUID('66949b0a-642b-4b93-949e-1dbbaf0df534') type=question
[info     ] Created flow node              [app.api.cms] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') node_id=ask_genre
[info     ] Created flow connection        [app.api.cms] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') source=welcome target=ask_genre
[info     ] Flow published                 [app.api.cms] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1')
------------------------------ Captured log setup ------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'name': 'Test Chat Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('42f99f73-5ba0-42ee-9f44-ce4426c37bc5'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'welcome', 'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('66949b0a-642b-4b93-949e-1dbbaf0df534'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'ask_genre', 'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:666 {'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'source': 'welcome', 'target': 'ask_genre', 'event': 'Created flow connection', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:443 {'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'event': 'Flow published', 'logger': 'app.api.cms', 'level': 'info'}
----------------------------- Captured stderr call -----------------------------
[info     ] Received flow event: session_started for session f15ba340-cd71-4c07-9d60-7769aa9bad65 [app.services.event_listener]
[info     ] Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_started [app.services.webhook_notifier]
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') session_id=UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65') user_id=None
[info     ] Received flow event: node_changed for session f15ba340-cd71-4c07-9d60-7769aa9bad65 [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome [app.services.event_listener]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: node_changed [app.services.webhook_notifier]
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1') session_id=UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65') user_id=None
[info     ] Received flow event: session_status_changed for session f15ba340-cd71-4c07-9d60-7769aa9bad65 [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully [app.services.event_listener]
[info     ] Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully [app.services.event_listener]
[info     ] Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_status_changed [app.services.webhook_notifier]
[info     ] Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_status_changed [app.services.webhook_notifier]
[info     ] Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_status_changed [app.services.webhook_notifier]
[info     ] Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_status_changed [app.services.webhook_notifier]
[info     ] Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome [app.services.event_listener]
[debug    ] No webhooks configured for event type: session_status_changed [app.services.webhook_notifier]
[info     ] Ended conversation session     [app.api.chat] session_id=UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65')
------------------------------ Captured log call -------------------------------
INFO     app.services.event_listener:event_listener.py:126 Received flow event: session_started for session f15ba340-cd71-4c07-9d60-7769aa9bad65
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_started - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: None
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_started
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65'), 'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'user_id': None, 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.services.event_listener:event_listener.py:126 Received flow event: node_changed for session f15ba340-cd71-4c07-9d60-7769aa9bad65
INFO     app.services.event_listener:event_listener.py:244 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:244 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 moved from None to welcome
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: node_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: node_changed
INFO     app.api.chat:chat.py:106 {'session_id': UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65'), 'flow_id': UUID('f953fa6e-c10e-433b-ac51-6980ad00fdb1'), 'user_id': None, 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.services.event_listener:event_listener.py:126 Received flow event: session_status_changed for session f15ba340-cd71-4c07-9d60-7769aa9bad65
INFO     app.services.event_listener:event_listener.py:237 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully
INFO     app.services.event_listener:event_listener.py:237 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully
INFO     app.services.event_listener:event_listener.py:237 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully
INFO     app.services.event_listener:event_listener.py:237 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully
INFO     app.services.event_listener:event_listener.py:237 Session f15ba340-cd71-4c07-9d60-7769aa9bad65 completed successfully
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_status_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_status_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_status_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_status_changed
INFO     app.services.event_listener:event_listener.py:229 Flow Event: session_status_changed - Session: f15ba340-cd71-4c07-9d60-7769aa9bad65 - Node: welcome
DEBUG    app.services.webhook_notifier:webhook_notifier.py:97 No webhooks configured for event type: session_status_changed
INFO     app.api.chat:chat.py:245 {'session_id': UUID('f15ba340-cd71-4c07-9d60-7769aa9bad65'), 'event': 'Ended conversation session', 'logger': 'app.api.chat', 'level': 'info'}
________________________ test_session_timeout_handling _________________________

client = <starlette.testclient.TestClient object at 0x7bca50c77d50>
test_flow_with_nodes = {'content_id': '52a4a218-2df1-47e9-a392-2ebe1373e8fd', 'flow_id': 'ba84f271-b804-4c25-9839-31c4f1a9e6f9', 'question_content_id': '0592e463-f960-4675-9382-30559ef29cac'}

    def test_session_timeout_handling(client, test_flow_with_nodes):
        """Test handling of session timeouts (if implemented)."""
        # Currently, sessions don't have built-in timeout mechanism
        # This test verifies that old sessions can still be accessed
        flow_id = test_flow_with_nodes["flow_id"]

        # Start a session
        response = client.post(f"v1/chat/{flow_id}/start", json={"user_id": None})
>       assert response.status_code == status.HTTP_200_OK
E       assert 404 == 200
E        +  where 404 = <Response [404 Not Found]>.status_code
E        +  and   200 = status.HTTP_200_OK

app/tests/integration/test_chat_api.py:630: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
---------------------------- Captured stderr setup -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9') name=Test Chat Flow
[info     ] Created content                [app.api.cms] content_id=UUID('52a4a218-2df1-47e9-a392-2ebe1373e8fd') type=message
[info     ] Created flow node              [app.api.cms] flow_id=UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9') node_id=welcome
[info     ] Created content                [app.api.cms] content_id=UUID('0592e463-f960-4675-9382-30559ef29cac') type=question
[info     ] Created flow node              [app.api.cms] flow_id=UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9') node_id=ask_genre
[info     ] Created flow connection        [app.api.cms] flow_id=UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9') source=welcome target=ask_genre
[info     ] Flow published                 [app.api.cms] flow_id=UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9')
------------------------------ Captured log setup ------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9'), 'name': 'Test Chat Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('52a4a218-2df1-47e9-a392-2ebe1373e8fd'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'welcome', 'flow_id': UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('0592e463-f960-4675-9382-30559ef29cac'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'ask_genre', 'flow_id': UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:666 {'flow_id': UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9'), 'source': 'welcome', 'target': 'ask_genre', 'event': 'Created flow connection', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:443 {'flow_id': UUID('ba84f271-b804-4c25-9839-31c4f1a9e6f9'), 'event': 'Flow published', 'logger': 'app.api.cms', 'level': 'info'}
________________________ test_rate_limiting_protection _________________________

client = <starlette.testclient.TestClient object at 0x7bca50c77d50>
test_flow_with_nodes = {'content_id': '7996a178-2063-4dfc-93b4-5a63edce8a16', 'flow_id': '65140ec4-38d5-40ce-8f34-a91ae3ed68c6', 'question_content_id': '208bc6c6-2a73-49f7-969a-0aebed417424'}

    def test_rate_limiting_protection(client, test_flow_with_nodes):
        """Test rate limiting protection for chat endpoints."""
        # Currently, rate limiting is not implemented at the application level
        # This test verifies that multiple rapid requests are handled normally
        flow_id = test_flow_with_nodes["flow_id"]

        # Make multiple rapid requests to start sessions
        responses = []
        for i in range(5):
            response = client.post(f"v1/chat/{flow_id}/start", json={"user_id": None})
            responses.append(response)

        # All requests should succeed (no rate limiting currently)
        for response in responses:
>           assert response.status_code == status.HTTP_200_OK
E           assert 404 == 200
E            +  where 404 = <Response [404 Not Found]>.status_code
E            +  and   200 = status.HTTP_200_OK

app/tests/integration/test_chat_api.py:724: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
---------------------------- Captured stderr setup -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6') name=Test Chat Flow
[info     ] Created content                [app.api.cms] content_id=UUID('7996a178-2063-4dfc-93b4-5a63edce8a16') type=message
[info     ] Created flow node              [app.api.cms] flow_id=UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6') node_id=welcome
[info     ] Created content                [app.api.cms] content_id=UUID('208bc6c6-2a73-49f7-969a-0aebed417424') type=question
[info     ] Created flow node              [app.api.cms] flow_id=UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6') node_id=ask_genre
[info     ] Created flow connection        [app.api.cms] flow_id=UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6') source=welcome target=ask_genre
[info     ] Flow published                 [app.api.cms] flow_id=UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6')
------------------------------ Captured log setup ------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6'), 'name': 'Test Chat Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('7996a178-2063-4dfc-93b4-5a63edce8a16'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'welcome', 'flow_id': UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('208bc6c6-2a73-49f7-969a-0aebed417424'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:551 {'node_id': 'ask_genre', 'flow_id': UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6'), 'event': 'Created flow node', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:666 {'flow_id': UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6'), 'source': 'welcome', 'target': 'ask_genre', 'event': 'Created flow connection', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:443 {'flow_id': UUID('65140ec4-38d5-40ce-8f34-a91ae3ed68c6'), 'event': 'Flow published', 'logger': 'app.api.cms', 'level': 'info'}
--------------------------- Captured stderr teardown ---------------------------
[info     ] Shutting down event system...  [app.events]
[info     ] Keep-alive task cancelled      [app.services.event_listener]
[info     ] Stopped listening for flow events [app.services.event_listener]
[info     ] Disconnected from PostgreSQL event listener [app.services.event_listener]
[info     ] Event system shut down successfully [app.events]
---------------------------- Captured log teardown -----------------------------
INFO     app.events:__init__.py:56 Shutting down event system...
INFO     app.services.event_listener:event_listener.py:205 Keep-alive task cancelled
INFO     app.services.event_listener:event_listener.py:192 Stopped listening for flow events
INFO     app.services.event_listener:event_listener.py:77 Disconnected from PostgreSQL event listener
INFO     app.events:__init__.py:66 Event system shut down successfully
___________ TestChatAPIScenarios.test_automated_bookbot_conversation ___________

self = <test_chat_api_scenarios.TestChatAPIScenarios object at 0x7bca5808b450>
async_client = <httpx.AsyncClient object at 0x7bca43d1cb50>
sample_bookbot_flow = UUID('6b2d61d5-6b15-45f9-841f-60e410ce0430')
test_user_account = <Public Reader integration test account (public) - Active>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDI5OTgsImlhdCI6MTc1NDE3MDk5OCwic3ViIjo...6c2VydmljZS1hY2NvdW50OmYwMWYwYTg0LTdjNDctNDI1ZC1iMjM4LTY4YjQ3NzI1MjFjZCJ9.3oFMrIwHTXt6PVvidkpiQaEhbCvm0rd41WWCQZAX8Os'}

    @pytest.mark.asyncio
    async def test_automated_bookbot_conversation(
        self, async_client, sample_bookbot_flow, test_user_account, backend_service_account_headers
    ):
        """Test automated BookBot conversation scenario."""
        flow_id = sample_bookbot_flow

        # Start conversation
        start_payload = {
            "flow_id": str(flow_id),
            "user_id": str(test_user_account.id),
            "initial_state": {
                "user_context": {
                    "test_session": True,
                    "started_at": datetime.utcnow().isoformat()
                }
            }
        }

        response = await async_client.post("/v1/chat/start", json=start_payload, headers=backend_service_account_headers)
        assert response.status_code == 201

        session_data = response.json()
        session_token = session_data["session_token"]

        # Verify initial welcome message
>       assert session_data["current_node_id"] == "welcome"
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E       KeyError: 'current_node_id'

app/tests/integration/test_chat_api_scenarios.py:211: KeyError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('6b2d61d5-6b15-45f9-841f-60e410ce0430') session_id=UUID('57927542-e215-4471-abf7-1fb60136a07f') user_id=UUID('92e4d638-2269-4f10-b08c-b04641fb0d96')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('6b2d61d5-6b15-45f9-841f-60e410ce0430') session_id=UUID('57927542-e215-4471-abf7-1fb60136a07f') user_id=UUID('92e4d638-2269-4f10-b08c-b04641fb0d96')
------------------------------ Captured log call -------------------------------
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('57927542-e215-4471-abf7-1fb60136a07f'), 'flow_id': UUID('6b2d61d5-6b15-45f9-841f-60e410ce0430'), 'user_id': UUID('92e4d638-2269-4f10-b08c-b04641fb0d96'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('57927542-e215-4471-abf7-1fb60136a07f'), 'flow_id': UUID('6b2d61d5-6b15-45f9-841f-60e410ce0430'), 'user_id': UUID('92e4d638-2269-4f10-b08c-b04641fb0d96'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
______________ TestChatAPIScenarios.test_conversation_end_session ______________

self = <test_chat_api_scenarios.TestChatAPIScenarios object at 0x7bca5808bf50>
async_client = <httpx.AsyncClient object at 0x7bca50346750>
sample_bookbot_flow = UUID('f4d54563-378b-41ae-8f1d-9f8f4b07319f')
test_user_account = <Public Reader integration test account (public) - Active>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDI5OTgsImlhdCI6MTc1NDE3MDk5OCwic3ViIjo...6c2VydmljZS1hY2NvdW50OjY4ZGMxM2IzLTgwMDUtNDA0NC1hNTllLWRjNzRkZDBiZmYzMCJ9.YSJ5fiXlzhCe7JCSzDvUzZ_VciUkjV3rQUOy-OzVHnk'}

    @pytest.mark.asyncio
    async def test_conversation_end_session(
        self, async_client, sample_bookbot_flow, test_user_account, backend_service_account_headers
    ):
        """Test ending a conversation session."""
        flow_id = sample_bookbot_flow

        # Start conversation
        start_payload = {
            "flow_id": str(flow_id),
            "user_id": str(test_user_account.id),
            "initial_state": {}
        }

        response = await async_client.post("/v1/chat/start", json=start_payload, headers=backend_service_account_headers)
        assert response.status_code == 201

        session_data = response.json()
        session_token = session_data["session_token"]

        # End session
        response = await async_client.post(f"/v1/chat/sessions/{session_token}/end", headers=backend_service_account_headers)
        assert response.status_code == 200

        # Verify session is marked as ended
        response = await async_client.get(f"/v1/chat/sessions/{session_token}", headers=backend_service_account_headers)
        assert response.status_code == 200

        session_state = response.json()
>       assert session_state.get("status") == "ended"
E       AssertionError: assert 'completed' == 'ended'
E
E         - ended
E         + completed

app/tests/integration/test_chat_api_scenarios.py:298: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('f4d54563-378b-41ae-8f1d-9f8f4b07319f') session_id=UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56') user_id=UUID('d25918cc-50d3-4b8b-8cdd-288c9eddd598')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('f4d54563-378b-41ae-8f1d-9f8f4b07319f') session_id=UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56') user_id=UUID('d25918cc-50d3-4b8b-8cdd-288c9eddd598')
[info     ] Ended conversation session     [app.api.chat] session_id=UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56')
------------------------------ Captured log call -------------------------------
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56'), 'flow_id': UUID('f4d54563-378b-41ae-8f1d-9f8f4b07319f'), 'user_id': UUID('d25918cc-50d3-4b8b-8cdd-288c9eddd598'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56'), 'flow_id': UUID('f4d54563-378b-41ae-8f1d-9f8f4b07319f'), 'user_id': UUID('d25918cc-50d3-4b8b-8cdd-288c9eddd598'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.api.chat:chat.py:245 {'session_id': UUID('7f0070ff-90f3-4339-9fc3-0d372b441c56'), 'event': 'Ended conversation session', 'logger': 'app.api.chat', 'level': 'info'}
____________ TestChatAPIScenarios.test_multiple_concurrent_sessions ____________

self = <test_chat_api_scenarios.TestChatAPIScenarios object at 0x7bca5809c510>
async_client = <httpx.AsyncClient object at 0x7bca42ed9490>
sample_bookbot_flow = UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99')
test_user_account = <Public Reader integration test account (public) - Active>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDI5OTgsImlhdCI6MTc1NDE3MDk5OCwic3ViIjo...6c2VydmljZS1hY2NvdW50Ojg2NWRkNDMzLWQzYWUtNDRkMC1iODNkLTdlNTQxMGI5N2YzNyJ9.sqYPtRYAhIWQv0uFSlLn58aQixK86XX34fvTgCHT4Ng'}

    @pytest.mark.asyncio
    async def test_multiple_concurrent_sessions(
        self, async_client, sample_bookbot_flow, test_user_account, backend_service_account_headers
    ):
        """Test handling multiple concurrent chat sessions."""
        flow_id = sample_bookbot_flow
        sessions = []

        # Start multiple sessions
        for i in range(3):
            start_payload = {
                "flow_id": str(flow_id),
                "user_id": str(test_user_account.id),
                "initial_state": {"session_number": i}
            }

            response = await async_client.post("/v1/chat/start", json=start_payload, headers=backend_service_account_headers)
            assert response.status_code == 201

            session_data = response.json()
            sessions.append(session_data["session_token"])

        # Verify all sessions are independent
        for i, session_token in enumerate(sessions):
            # Send different input to each session
            interact_payload = {
                "input": str(10 + i),  # Different ages
                "input_type": "text"
            }

            response = await async_client.post(
                f"/v1/chat/sessions/{session_token}/interact",
                json=interact_payload,
                headers=backend_service_account_headers
            )

            assert response.status_code == 200

            # Verify session state is independent
            response = await async_client.get(f"/v1/chat/sessions/{session_token}", headers=backend_service_account_headers)
            assert response.status_code == 200

            session_state = response.json()
            state_vars = session_state.get("state", {})
>           assert state_vars.get("user_age") == str(10 + i)
E           AssertionError: assert None == '10'
E            +  where None = <built-in method get of dict object at 0x7bca435eba40>('user_age')
E            +    where <built-in method get of dict object at 0x7bca435eba40> = {'session_number': 0}.get
E            +  and   '10' = str((10 + 0))

app/tests/integration/test_chat_api_scenarios.py:386: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('3ccef307-f299-4f39-8789-95f87df63e18') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('3ccef307-f299-4f39-8789-95f87df63e18') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('ac0b2714-dde5-4afc-9164-71d614d581cb') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('ac0b2714-dde5-4afc-9164-71d614d581cb') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('d2fffa0e-ef42-455d-8227-25a11bb3461a') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99') session_id=UUID('d2fffa0e-ef42-455d-8227-25a11bb3461a') user_id=UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5')
[info     ] Processed interaction          [app.api.chat] input_type=text session_id=UUID('3ccef307-f299-4f39-8789-95f87df63e18')
------------------------------ Captured log call -------------------------------
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('3ccef307-f299-4f39-8789-95f87df63e18'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('3ccef307-f299-4f39-8789-95f87df63e18'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('ac0b2714-dde5-4afc-9164-71d614d581cb'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('ac0b2714-dde5-4afc-9164-71d614d581cb'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('d2fffa0e-ef42-455d-8227-25a11bb3461a'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('d2fffa0e-ef42-455d-8227-25a11bb3461a'), 'flow_id': UUID('5d8fd94d-a4b0-4be1-aee4-9f1d5c5edb99'), 'user_id': UUID('5e651d67-3877-46ec-b00c-fbca803fa7e5'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.api.chat:chat.py:184 {'session_id': UUID('3ccef307-f299-4f39-8789-95f87df63e18'), 'input_type': 'text', 'event': 'Processed interaction', 'logger': 'app.api.chat', 'level': 'info'}
_________ TestChatAPIScenarios.test_variable_substitution_in_messages __________

self = <test_chat_api_scenarios.TestChatAPIScenarios object at 0x7bca5809cd50>
async_client = <httpx.AsyncClient object at 0x7bca435359d0>
sample_bookbot_flow = UUID('ddef56d7-9735-4f5a-b9e2-f47f9703a9a7')
test_user_account = <Public Reader integration test account (public) - Active>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDI5OTksImlhdCI6MTc1NDE3MDk5OSwic3ViIjo...6c2VydmljZS1hY2NvdW50OmM4ZTU2NTdkLWZiZjQtNDVkYS1iMjU4LTZhYTQ3ZjYxNDdmZiJ9.3kQJdsf3pY28751nsKZQLwmMS96j9mAPFJcQFvs4CSE'}

    @pytest.mark.asyncio
    async def test_variable_substitution_in_messages(
        self, async_client, sample_bookbot_flow, test_user_account, backend_service_account_headers
    ):
        """Test that variables are properly substituted in bot messages."""
        flow_id = sample_bookbot_flow

        # Start conversation and progress to recommendations
        start_payload = {
            "flow_id": str(flow_id),
            "user_id": str(test_user_account.id),
            "initial_state": {}
        }

        response = await async_client.post("/v1/chat/start", json=start_payload, headers=backend_service_account_headers)
        session_token = response.json()["session_token"]

        # Progress through conversation
        inputs = ["8", "Advanced", "Science Fiction"]

        for user_input in inputs:
            interact_payload = {"input": user_input, "input_type": "text"}
            response = await async_client.post(
                f"/v1/chat/sessions/{session_token}/interact",
                json=interact_payload,
                headers=backend_service_account_headers
            )
>           assert response.status_code == 200
E           assert 400 == 200
E            +  where 400 = <Response [400 Bad Request]>.status_code

app/tests/integration/test_chat_api_scenarios.py:419: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Started conversation session   [app.services.chat_runtime] flow_id=UUID('ddef56d7-9735-4f5a-b9e2-f47f9703a9a7') session_id=UUID('ed3e906e-c291-4bd3-b85c-58293088be86') user_id=UUID('d3cd61b3-d2fa-4a18-a49e-3d6d925d494d')
[info     ] Started conversation session   [app.api.chat] csrf_token_set=True flow_id=UUID('ddef56d7-9735-4f5a-b9e2-f47f9703a9a7') session_id=UUID('ed3e906e-c291-4bd3-b85c-58293088be86') user_id=UUID('d3cd61b3-d2fa-4a18-a49e-3d6d925d494d')
[info     ] Processed interaction          [app.api.chat] input_type=text session_id=UUID('ed3e906e-c291-4bd3-b85c-58293088be86')
[info     ] Processed interaction          [app.api.chat] input_type=text session_id=UUID('ed3e906e-c291-4bd3-b85c-58293088be86')
------------------------------ Captured log call -------------------------------
INFO     app.services.chat_runtime:chat_runtime.py:368 {'session_id': UUID('ed3e906e-c291-4bd3-b85c-58293088be86'), 'flow_id': UUID('ddef56d7-9735-4f5a-b9e2-f47f9703a9a7'), 'user_id': UUID('d3cd61b3-d2fa-4a18-a49e-3d6d925d494d'), 'event': 'Started conversation session', 'logger': 'app.services.chat_runtime', 'level': 'info'}
INFO     app.api.chat:chat.py:106 {'session_id': UUID('ed3e906e-c291-4bd3-b85c-58293088be86'), 'flow_id': UUID('ddef56d7-9735-4f5a-b9e2-f47f9703a9a7'), 'user_id': UUID('d3cd61b3-d2fa-4a18-a49e-3d6d925d494d'), 'csrf_token_set': True, 'event': 'Started conversation session', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.api.chat:chat.py:184 {'session_id': UUID('ed3e906e-c291-4bd3-b85c-58293088be86'), 'input_type': 'text', 'event': 'Processed interaction', 'logger': 'app.api.chat', 'level': 'info'}
INFO     app.api.chat:chat.py:184 {'session_id': UUID('ed3e906e-c291-4bd3-b85c-58293088be86'), 'input_type': 'text', 'event': 'Processed interaction', 'logger': 'app.api.chat', 'level': 'info'}
__________ TestCircuitBreaker.test_circuit_breaker_recovery_to_closed __________

self = <test_circuit_breaker.TestCircuitBreaker object at 0x7bca593ea410>
circuit_breaker = <app.services.circuit_breaker.CircuitBreaker object at 0x7bca43b9d790>

    @pytest.mark.asyncio
    async def test_circuit_breaker_recovery_to_closed(self, circuit_breaker):
        """Test recovery from HALF_OPEN to CLOSED state."""

        async def sometimes_failing_func(should_fail=True):
            if should_fail:
                raise Exception("Service error")
            return {"success": True}

        # Force to OPEN state
        for _ in range(3):
>           with pytest.raises(Exception):
E           Failed: DID NOT RAISE <class 'Exception'>

app/tests/integration/test_circuit_breaker.py:153: Failed
----------------------------- Captured stderr call -----------------------------
[debug    ] Circuit breaker test_service recorded success - count: 1 [app.services.circuit_breaker]
------------------------------ Captured log call -------------------------------
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 1
____________ TestCircuitBreaker.test_circuit_breaker_stats_tracking ____________

self = <test_circuit_breaker.TestCircuitBreaker object at 0x7bca593ebe90>
circuit_breaker = <app.services.circuit_breaker.CircuitBreaker object at 0x7bca513edf90>

    @pytest.mark.asyncio
    async def test_circuit_breaker_stats_tracking(self, circuit_breaker):
        """Test comprehensive stats tracking."""

        async def mixed_func(should_fail=False):
            if should_fail:
                raise Exception("Error")
            return {"success": True}

        # Mix of successes and failures
        await circuit_breaker.call(lambda: mixed_func(False))  # Success
>       with pytest.raises(Exception):
E       Failed: DID NOT RAISE <class 'Exception'>

app/tests/integration/test_circuit_breaker.py:203: Failed
----------------------------- Captured stderr call -----------------------------
[debug    ] Circuit breaker test_service recorded success - count: 1 [app.services.circuit_breaker]
[debug    ] Circuit breaker test_service recorded success - count: 2 [app.services.circuit_breaker]
------------------------------ Captured log call -------------------------------
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 1
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 2
__________ TestCircuitBreaker.test_circuit_breaker_concurrent_access ___________

self = <test_circuit_breaker.TestCircuitBreaker object at 0x7bca593ead10>
circuit_breaker = <app.services.circuit_breaker.CircuitBreaker object at 0x7bca513ef310>

    @pytest.mark.asyncio
    async def test_circuit_breaker_concurrent_access(self, circuit_breaker):
        """Test circuit breaker with concurrent access."""

        async def slow_func(delay=0.1, should_fail=False):
            await asyncio.sleep(delay)
            if should_fail:
                raise Exception("Slow error")
            return {"completed": True}

        # Run multiple concurrent operations
        tasks = []
        for i in range(5):
            task = asyncio.create_task(
                circuit_breaker.call(lambda: slow_func(0.05, i % 2 == 0))
            )
            tasks.append(task)

        # Wait for all to complete (some will fail)
        results = await asyncio.gather(*tasks, return_exceptions=True)

        # Check that we got a mix of results and exceptions
        successes = [r for r in results if isinstance(r, dict)]
        failures = [r for r in results if isinstance(r, Exception)]

>       assert len(successes) + len(failures) == 5
E       assert (0 + 0) == 5
E        +  where 0 = len([])
E        +  and   0 = len([])

app/tests/integration/test_circuit_breaker.py:293: AssertionError
----------------------------- Captured stderr call -----------------------------
[debug    ] Circuit breaker test_service recorded success - count: 1 [app.services.circuit_breaker]
[debug    ] Circuit breaker test_service recorded success - count: 2 [app.services.circuit_breaker]
[debug    ] Circuit breaker test_service recorded success - count: 3 [app.services.circuit_breaker]
[debug    ] Circuit breaker test_service recorded success - count: 4 [app.services.circuit_breaker]
[debug    ] Circuit breaker test_service recorded success - count: 5 [app.services.circuit_breaker]
------------------------------ Captured log call -------------------------------
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 1
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 2
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 3
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 4
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker test_service recorded success - count: 5
__ TestCircuitBreakerIntegration.test_circuit_breaker_with_webhook_simulation __

self = <test_circuit_breaker.TestCircuitBreakerIntegration object at 0x7bca593f69d0>

    @pytest.mark.asyncio
    async def test_circuit_breaker_with_webhook_simulation(self):
        """Test circuit breaker protecting webhook calls."""
        import aiohttp

        cb = get_circuit_breaker("webhook_test")
        cb.stats.state = CircuitBreakerState.CLOSED  # Reset state

        async def mock_webhook_call(url, should_fail=False):
            """Simulate a webhook call."""
            if should_fail:
                raise aiohttp.ClientError("Connection failed")
            return {"status": "success", "data": "webhook response"}

        # Test successful webhook calls
        result = await cb.call(
            lambda: mock_webhook_call("https://api.example.com", False)
        )
>       assert result["status"] == "success"
               ^^^^^^^^^^^^^^^^
E       TypeError: 'coroutine' object is not subscriptable

app/tests/integration/test_circuit_breaker.py:424: TypeError
----------------------------- Captured stderr call -----------------------------
[debug    ] Circuit breaker webhook_test recorded success - count: 1 [app.services.circuit_breaker]
------------------------------ Captured log call -------------------------------
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker webhook_test recorded success - count: 1
____ TestCircuitBreakerIntegration.test_circuit_breaker_recovery_simulation ____

self = <test_circuit_breaker.TestCircuitBreakerIntegration object at 0x7bca593f74d0>

    @pytest.mark.asyncio
    async def test_circuit_breaker_recovery_simulation(self):
        """Test circuit breaker recovery in realistic scenario."""
        cb = get_circuit_breaker("recovery_test")
        await cb.reset()  # Clean state

        call_results = []

        async def api_call(service_healthy=True):
            """Simulate API that can be healthy or unhealthy."""
            if not service_healthy:
                raise Exception("Service unavailable")
            return {"timestamp": datetime.utcnow().isoformat(), "healthy": True}

        # Phase 1: Service is healthy
        for _ in range(5):
            result = await cb.call(lambda: api_call(True))
            call_results.append(("success", result))

        assert cb.stats.state == CircuitBreakerState.CLOSED

        # Phase 2: Service becomes unhealthy
        for _ in range(3):
            try:
                result = await cb.call(lambda: api_call(False))
                call_results.append(("success", result))
            except Exception as e:
                call_results.append(("failure", str(e)))

>       assert cb.stats.state == CircuitBreakerState.OPEN
E       AssertionError: assert <CircuitBreak...SED: 'closed'> == <CircuitBreak....OPEN: 'open'>
E
E         - open
E         + closed

app/tests/integration/test_circuit_breaker.py:475: AssertionError
----------------------------- Captured stderr call -----------------------------
[info     ] Manually resetting circuit breaker recovery_test [app.services.circuit_breaker]
[info     ] Circuit breaker recovery_test transitioning to CLOSED [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 1 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 2 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 3 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 4 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 5 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 6 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 7 [app.services.circuit_breaker]
[debug    ] Circuit breaker recovery_test recorded success - count: 8 [app.services.circuit_breaker]
------------------------------ Captured log call -------------------------------
INFO     app.services.circuit_breaker:circuit_breaker.py:223 Manually resetting circuit breaker recovery_test
INFO     app.services.circuit_breaker:circuit_breaker.py:198 Circuit breaker recovery_test transitioning to CLOSED
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 1
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 2
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 3
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 4
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 5
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 6
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 7
DEBUG    app.services.circuit_breaker:circuit_breaker.py:148 Circuit breaker recovery_test recorded success - count: 8
___________ TestCMSAPIEnhanced.test_content_filtering_comprehensive ____________

self = <test_cms_api_enhanced.TestCMSAPIEnhanced object at 0x7bca593cc310>
async_client = <httpx.AsyncClient object at 0x7bca50c51f10>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwMDYsImlhdCI6MTc1NDE3MTAwNiwic3ViIjo...6c2VydmljZS1hY2NvdW50OmQwMWM1NWM5LTM2ZGEtNGI1My04ZWQwLWUzMmFkNWQwYTFiNiJ9.yRxCUViHog9s1mCq81lsRMhMQWljBE58pBieVRmfI5w'}

    @pytest.mark.asyncio
    async def test_content_filtering_comprehensive(
        self, async_client, backend_service_account_headers
    ):
        """Test comprehensive content filtering scenarios."""
        # First create some test content to filter
        test_contents = [
            {
                "type": "joke",
                "content": {
                    "setup": "Why don't scientists trust atoms?",
                    "punchline": "Because they make up everything!",
                    "category": "science",
                    "age_group": ["7-10", "11-14"]
                },
                "tags": ["science", "funny", "kids"],
                "status": "published",
            },
            {
                "type": "question",
                "content": {
                    "question": "What's your favorite color?",
                    "input_type": "text",
                    "category": "personal"
                },
                "tags": ["personal", "simple"],
                "status": "draft",
            },
            {
                "type": "message",
                "content": {
                    "text": "Welcome to our science quiz!",
                    "category": "science"
                },
                "tags": ["science", "welcome"],
                "status": "published",
            }
        ]

        created_content_ids = []

        # Create test content
        for content_data in test_contents:
            response = await async_client.post(
                "/v1/cms/content",
                json=content_data,
                headers=backend_service_account_headers
            )
            assert response.status_code == 201
            created_content_ids.append(response.json()["id"])

        # Test various filters
        filter_tests = [
            # Search filter
            {
                "params": {"search": "science"},
                "expected_min_count": 2,  # Should find science joke and message
                "description": "Search for 'science'"
            },
            # Content type filter
            {
                "params": {"content_type": "joke"},
                "expected_min_count": 1,
                "description": "Filter by joke content type"
            },
            # Status filter
            {
                "params": {"status": "published"},
                "expected_min_count": 2,  # Joke and message are published
                "description": "Filter by published status"
            },
            # Tag filter
            {
                "params": {"tags": "science"},
                "expected_min_count": 2,
                "description": "Filter by science tag"
            },
            # Limit filter
            {
                "params": {"limit": 1},
                "expected_count": 1,  # Exact count
                "description": "Limit results to 1"
            },
            # Combined filters
            {
                "params": {"content_type": "joke", "tags": "science"},
                "expected_min_count": 1,
                "description": "Combined content type and tag filter"
            }
        ]

        for filter_test in filter_tests:
            response = await async_client.get(
                "/v1/cms/content",
                params=filter_test["params"],
                headers=backend_service_account_headers
            )

            assert response.status_code == 200, f"Filter failed: {filter_test['description']}"

            data = response.json()
            content_items = data.get("data", [])

            # Check count expectations
            if "expected_count" in filter_test:
                assert len(content_items) == filter_test["expected_count"], \
                    f"Expected exactly {filter_test['expected_count']} items for {filter_test['description']}"
            elif "expected_min_count" in filter_test:
>               assert len(content_items) >= filter_test["expected_min_count"], \
                    f"Expected at least {filter_test['expected_min_count']} items for {filter_test['description']}"
E               AssertionError: Expected at least 2 items for Search for 'science'
E               assert 1 >= 2
E                +  where 1 = len([{'content': {'category': 'science', 'text': 'Welcome to our science quiz!'}, 'created_at': '2025-08-02T21:43:27.058659', 'created_by': None, 'id': '2693708f-a515-45af-80e6-043638322645', ...}])

app/tests/integration/test_cms_api_enhanced.py:124: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created content                [app.api.cms] content_id=UUID('469fbb8d-dc98-400a-b16a-1ecafe230103') type=joke
[info     ] Created content                [app.api.cms] content_id=UUID('6a8485e9-2d49-4dc8-b732-bad27a8f8f03') type=question
[info     ] Created content                [app.api.cms] content_id=UUID('2693708f-a515-45af-80e6-043638322645') type=message
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': 'science', 'active': None} total=1
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:146 {'content_id': UUID('469fbb8d-dc98-400a-b16a-1ecafe230103'), 'type': <ContentType.JOKE: 'joke'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('6a8485e9-2d49-4dc8-b732-bad27a8f8f03'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('2693708f-a515-45af-80e6-043638322645'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': 'science', 'active': None}, 'total': 1, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
____________ TestCMSAPIEnhanced.test_content_creation_comprehensive ____________

self = <test_cms_api_enhanced.TestCMSAPIEnhanced object at 0x7bca593ccb50>
async_client = <httpx.AsyncClient object at 0x7bca435a4310>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwMDcsImlhdCI6MTc1NDE3MTAwNywic3ViIjo...6c2VydmljZS1hY2NvdW50OjMzYTZlOTQxLTMwNDMtNGUwNS04OWM1LWM4ZWFkYmI1OGI5ZiJ9.vx07Gk5ehBP3GD24iBMK8mxc5wb05dHzBuHUu4ymqGU'}

    @pytest.mark.asyncio
    async def test_content_creation_comprehensive(
        self, async_client, backend_service_account_headers
    ):
        """Test comprehensive content creation scenarios."""
        content_types_to_test = [
            {
                "type": "joke",
                "content": {
                    "setup": "Why did the math book look so sad?",
                    "punchline": "Because it had too many problems!",
                    "category": "education",
                    "age_group": ["8-12", "13-16"]
                },
                "tags": ["math", "education", "funny"],
                "metadata": {
                    "source": "test_suite",
                    "difficulty": "easy",
                    "created_by": "api_test"
                }
            },
            {
                "type": "question",
                "content": {
                    "question": "What's the capital of Australia?",
                    "input_type": "choice",
                    "options": ["Sydney", "Melbourne", "Canberra", "Perth"],
                    "correct_answer": "Canberra",
                    "category": "geography"
                },
                "tags": ["geography", "capitals", "australia"],
                "metadata": {
                    "difficulty": "medium",
                    "region": "oceania"
                }
            },
            {
                "type": "message",
                "content": {
                    "text": "Great job! You're doing fantastic in this quiz.",
                    "style": "encouraging",
                    "category": "feedback"
                },
                "tags": ["encouragement", "feedback", "positive"],
                "metadata": {
                    "tone": "friendly",
                    "context": "quiz_completion"
                }
            }
        ]

        created_content = []

        for content_data in content_types_to_test:
            # Test creation
            response = await async_client.post(
                "/v1/cms/content",
                json=content_data,
                headers=backend_service_account_headers
            )

            assert response.status_code == 201
            created_item = response.json()
            created_content.append(created_item)

            # Verify created content structure
            assert created_item["type"] == content_data["type"]
            assert created_item["content"] == content_data["content"]
            assert created_item["tags"] == content_data["tags"]
            assert created_item["version"] == 1
            assert created_item["is_active"] is True

            # Verify metadata is stored
            if "metadata" in content_data:
>               assert created_item["metadata"] == content_data["metadata"]
                       ^^^^^^^^^^^^^^^^^^^^^^^^
E               KeyError: 'metadata'

app/tests/integration/test_cms_api_enhanced.py:208: KeyError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created content                [app.api.cms] content_id=UUID('5037b288-0820-436d-b941-15bfa5bc1ae0') type=joke
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:146 {'content_id': UUID('5037b288-0820-436d-b941-15bfa5bc1ae0'), 'type': <ContentType.JOKE: 'joke'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
_____________ TestCMSAPIEnhanced.test_flow_creation_comprehensive ______________

self = <test_cms_api_enhanced.TestCMSAPIEnhanced object at 0x7bca593cda10>
async_client = <httpx.AsyncClient object at 0x7bca435a7410>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwMDcsImlhdCI6MTc1NDE3MTAwNywic3ViIjo...6c2VydmljZS1hY2NvdW50OjVkMjA2ZWZlLTJiOGYtNGQ2Zi05YzMzLTM0N2I5MzZhN2VkYyJ9.6BlXl4z38yRgY6Pxp-hZoNXvCp6TarATmTcCPmZ2lQQ'}

    @pytest.mark.asyncio
    async def test_flow_creation_comprehensive(
        self, async_client, backend_service_account_headers
    ):
        """Test comprehensive flow creation scenarios."""
        sample_flows = [
            {
                "name": "Simple Welcome Flow",
                "description": "A basic welcome flow for new users",
                "version": "1.0.0",
                "flow_data": {
                    "nodes": [
                        {
                            "id": "welcome",
                            "type": "message",
                            "content": {
                                "messages": [
                                    {
                                        "type": "text",
                                        "content": "Welcome to our platform!"
                                    }
                                ]
                            },
                            "connections": ["ask_name"]
                        },
                        {
                            "id": "ask_name",
                            "type": "question",
                            "content": {
                                "question": "What's your name?",
                                "input_type": "text",
                                "variable": "user_name"
                            },
                            "connections": ["personalized_greeting"]
                        },
                        {
                            "id": "personalized_greeting",
                            "type": "message",
                            "content": {
                                "messages": [
                                    {
                                        "type": "text",
                                        "content": "Nice to meet you, {{user_name}}!"
                                    }
                                ]
                            }
                        }
                    ]
                },
                "entry_node_id": "welcome",
                "metadata": {
                    "category": "onboarding",
                    "difficulty": "beginner",
                    "estimated_duration": "2-3 minutes"
                }
            },
            {
                "name": "Quiz Flow",
                "description": "A multi-question quiz flow",
                "version": "1.0.0",
                "flow_data": {
                    "nodes": [
                        {
                            "id": "intro",
                            "type": "message",
                            "content": {
                                "messages": [
                                    {
                                        "type": "text",
                                        "content": "Let's start a quick quiz!"
                                    }
                                ]
                            },
                            "connections": ["q1"]
                        },
                        {
                            "id": "q1",
                            "type": "question",
                            "content": {
                                "question": "What is 2 + 2?",
                                "input_type": "choice",
                                "options": ["3", "4", "5"],
                                "variable": "answer_1"
                            },
                            "connections": ["results"]
                        },
                        {
                            "id": "results",
                            "type": "message",
                            "content": {
                                "messages": [
                                    {
                                        "type": "text",
                                        "content": "Your answer was: {{answer_1}}"
                                    }
                                ]
                            }
                        }
                    ]
                },
                "entry_node_id": "intro",
                "metadata": {
                    "category": "assessment",
                    "subject": "mathematics",
                    "grade_level": "elementary"
                }
            }
        ]

        created_flows = []

        for flow_data in sample_flows:
            # Create flow
            response = await async_client.post(
                "/v1/cms/flows",
                json=flow_data,
                headers=backend_service_account_headers
            )

            assert response.status_code == 201
            created_flow = response.json()
            created_flows.append(created_flow)

            # Verify flow structure
            assert created_flow["name"] == flow_data["name"]
            assert created_flow["description"] == flow_data["description"]
            assert created_flow["version"] == flow_data["version"]
            assert created_flow["entry_node_id"] == flow_data["entry_node_id"]
            assert created_flow["is_active"] is True

            # Verify metadata
            if "metadata" in flow_data:
>               assert created_flow["metadata"] == flow_data["metadata"]
                       ^^^^^^^^^^^^^^^^^^^^^^^^
E               KeyError: 'metadata'

app/tests/integration/test_cms_api_enhanced.py:381: KeyError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('b71aefa1-2d4f-45d3-a434-4512d32967e7') name=Simple Welcome Flow
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('b71aefa1-2d4f-45d3-a434-4512d32967e7'), 'name': 'Simple Welcome Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
____________________ TestCMSAPIEnhanced.test_cms_pagination ____________________

self = <test_cms_api_enhanced.TestCMSAPIEnhanced object at 0x7bca593ce5d0>
async_client = <httpx.AsyncClient object at 0x7bca42e4fcd0>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwMDcsImlhdCI6MTc1NDE3MTAwNywic3ViIjo...6c2VydmljZS1hY2NvdW50OmMxNzhmZGM5LTc1YzAtNGQ0NC1iMDM0LWQzMjAyYzg4MjhmMSJ9.gFvAzZZeK-QNuuot6918-BIPfei_RCmCf7511krYwx8'}

    @pytest.mark.asyncio
    async def test_cms_pagination(
        self, async_client, backend_service_account_headers
    ):
        """Test CMS API pagination functionality."""
        # Create multiple content items for pagination testing
        content_items = []
        for i in range(15):  # Create more than default page size
            content_data = {
                "type": "message",
                "content": {
                    "text": f"Test message {i}",
                    "category": "test"
                },
                "tags": ["test", "pagination"],
                "metadata": {"test_index": i}
            }

            response = await async_client.post(
                "/v1/cms/content",
                json=content_data,
                headers=backend_service_account_headers
            )
            assert response.status_code == 201
            content_items.append(response.json()["id"])

        # Test pagination
        response = await async_client.get(
            "/v1/cms/content",
            params={"limit": 5, "tags": "pagination"},
            headers=backend_service_account_headers
        )

        assert response.status_code == 200
        data = response.json()

        # Verify pagination metadata
        assert "pagination" in data
        pagination = data["pagination"]
        assert "total" in pagination
>       assert "page" in pagination
E       AssertionError: assert 'page' in {'limit': 5, 'skip': 0, 'total': 15}

app/tests/integration/test_cms_api_enhanced.py:515: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created content                [app.api.cms] content_id=UUID('71a565e7-b03f-4be2-bb22-8b2f995d426a') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('e75bcfa2-b47e-4f05-aea2-79910912170b') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('eb050bcd-4917-4336-b497-5a0be3220abf') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('5b6ac08a-fcfa-4b64-9c83-cbad7d5dbebb') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('628600e7-67ee-4476-9261-6217c8ebfc74') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('c11fd839-2833-407a-ae02-4975eb334195') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('e6abe739-0ddb-4f80-bcac-410ddc6ee679') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('19380f62-b487-46ff-bd88-4c299f2b5d06') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('b4cd7540-c556-43f2-a0a3-87bcc50f5d29') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('56d13e35-d410-4935-86f5-862a85d23284') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('35537924-cd37-4236-b09e-e16b15c7bfc7') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('00c934dd-df6f-4921-bcd8-1868ef5f24de') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('93a268d1-43d9-488e-916a-05002bc4df9e') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('6be917f8-a22e-47ae-889f-0f619fc1213d') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('d2b0f485-62a9-4a91-95f6-c503ecf00265') type=message
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': ['pagination'], 'search': None, 'active': None} total=15
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:146 {'content_id': UUID('71a565e7-b03f-4be2-bb22-8b2f995d426a'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('e75bcfa2-b47e-4f05-aea2-79910912170b'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('eb050bcd-4917-4336-b497-5a0be3220abf'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('5b6ac08a-fcfa-4b64-9c83-cbad7d5dbebb'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('628600e7-67ee-4476-9261-6217c8ebfc74'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('c11fd839-2833-407a-ae02-4975eb334195'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('e6abe739-0ddb-4f80-bcac-410ddc6ee679'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('19380f62-b487-46ff-bd88-4c299f2b5d06'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('b4cd7540-c556-43f2-a0a3-87bcc50f5d29'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('56d13e35-d410-4935-86f5-862a85d23284'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('35537924-cd37-4236-b09e-e16b15c7bfc7'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('00c934dd-df6f-4921-bcd8-1868ef5f24de'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('93a268d1-43d9-488e-916a-05002bc4df9e'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('6be917f8-a22e-47ae-889f-0f619fc1213d'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('d2b0f485-62a9-4a91-95f6-c503ecf00265'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': ['pagination'], 'search': None, 'active': None}, 'total': 15, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
_______ TestCMSWithAuthentication.test_chat_start_does_not_require_auth ________

self = <test_cms_authenticated.TestCMSWithAuthentication object at 0x7bca593da990>
client = <starlette.testclient.TestClient object at 0x7bca42f596d0>

    def test_chat_start_does_not_require_auth(self, client):
        """Test that chat start endpoint does not require authentication."""
        # This should fail for other reasons (invalid flow), but not auth
        response = client.post(
            "/v1/chat/start",
            json={"flow_id": str(uuid4()), "user_id": None, "initial_state": {}},
        )

        # Should not be 401 (auth error), but 400 (flow not found)
        assert response.status_code != 401
>       assert response.status_code == 400
E       assert 404 == 400
E        +  where 404 = <Response [404 Not Found]>.status_code

app/tests/integration/test_cms_authenticated.py:55: AssertionError
___________ TestCMSWithAuthentication.test_get_flow_nodes_with_auth ____________

self = <test_cms_authenticated.TestCMSWithAuthentication object at 0x7bca593dad50>
client = <starlette.testclient.TestClient object at 0x7bca42f596d0>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwNjksImlhdCI6MTc1NDE3MTA2OSwic3ViIjo...6c2VydmljZS1hY2NvdW50OjdkNTM4Y2E3LTMxYTQtNDA1Ny1hMDJiLTJmY2FhZWI2ZmI4NCJ9.MKCDHhnn_E__YlcRKb1A_AFxALLLPXAr0Q4Eh71fYeo'}

    def test_get_flow_nodes_with_auth(self, client, backend_service_account_headers):
        """Test getting flow nodes with authentication."""
        # Create a flow first
        flow_data = {
            "name": "Test Node Flow",
            "description": "A flow for testing nodes",
            "version": "1.0",
            "flow_data": {
                "nodes": [
                    {
                        "id": "welcome",
                        "type": "MESSAGE",
                        "content": {"text": "Welcome!"},
                        "position": {"x": 100, "y": 100},
                    },
                    {
                        "id": "ask_question",
                        "type": "QUESTION",
                        "content": {
                            "text": "What's your name?",
                            "variable": "user_name",
                        },
                        "position": {"x": 100, "y": 200},
                    },
                ],
                "connections": [
                    {"source": "welcome", "target": "ask_question", "type": "DEFAULT"}
                ],
            },
            "entry_node_id": "welcome",
            "info": {"test": "node_test"},
        }

        flow_response = client.post(
            "/v1/cms/flows", json=flow_data, headers=backend_service_account_headers
        )
        assert flow_response.status_code == 201
        flow_id = flow_response.json()["id"]

        response = client.get(
            f"/v1/cms/flows/{flow_id}/nodes", headers=backend_service_account_headers
        )

        assert response.status_code == 200
        data = response.json()
        assert "data" in data
>       assert len(data["data"]) == 2
E       assert 0 == 2
E        +  where 0 = len([])

app/tests/integration/test_cms_authenticated.py:226: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('cde09be1-a5d9-4559-a9d4-07c6798d9503') name=Test Node Flow
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('cde09be1-a5d9-4559-a9d4-07c6798d9503'), 'name': 'Test Node Flow', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
_____ TestCMSWithAuthentication.test_start_chat_session_with_created_flow ______

self = <test_cms_authenticated.TestCMSWithAuthentication object at 0x7bca593db590>
client = <starlette.testclient.TestClient object at 0x7bca42f596d0>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwNjksImlhdCI6MTc1NDE3MTA2OSwic3ViIjo...6c2VydmljZS1hY2NvdW50OmY3YzcxNzNkLTE3OGMtNDUzMy1iYTcxLTg0NDlkZDk1ZTE5YSJ9.e3EWvFWp5XTQ1JuqyjlYloRsR68tLybT30x8vTWOess'}

    def test_start_chat_session_with_created_flow(
        self, client, backend_service_account_headers
    ):
        """Test starting a chat session with a flow we created."""
        # Create a published flow first
        flow_id = self.test_create_flow_definition_with_auth(
            client, backend_service_account_headers
        )

        session_data = {
            "flow_id": flow_id,
            "user_id": None,
            "initial_state": {"test_mode": True, "source": "pytest"},
        }

        response = client.post("/v1/chat/start", json=session_data)

>       assert response.status_code == 201
E       assert 422 == 201
E        +  where 422 = <Response [422 Unprocessable Entity]>.status_code

app/tests/integration/test_cms_authenticated.py:250: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created flow                   [app.api.cms] flow_id=UUID('dbb82b24-e21d-425f-b592-244993c726f8') name=Test Programming Assessment
[warning  ] The client sent invalid data!: [{'type': 'uuid_type', 'loc': ('body', 'flow_id'), 'msg': 'UUID input should be a string, bytes or UUID object', 'input': None}]

[{'type': 'uuid_type', 'loc': ('body', 'flow_id'), 'msg': 'UUID input should be a string, bytes or UUID object', 'input': None}] [app.main] request=URL('http://testserver/v1/chat/start')
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('dbb82b24-e21d-425f-b592-244993c726f8'), 'name': 'Test Programming Assessment', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
WARNING  app.main:main.py:74 {'request': URL('http://testserver/v1/chat/start'), 'event': "The client sent invalid data!: [{'type': 'uuid_type', 'loc': ('body', 'flow_id'), 'msg': 'UUID input should be a string, bytes or UUID object', 'input': None}]\n\n[{'type': 'uuid_type', 'loc': ('body', 'flow_id'), 'msg': 'UUID input should be a string, bytes or UUID object', 'input': None}]", 'logger': 'app.main', 'level': 'warning'}
_________ TestCMSWithAuthentication.test_complete_cms_to_chat_workflow _________

self = <test_cms_authenticated.TestCMSWithAuthentication object at 0x7bca593d8150>
client = <starlette.testclient.TestClient object at 0x7bca42f596d0>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwNjksImlhdCI6MTc1NDE3MTA2OSwic3ViIjo...6c2VydmljZS1hY2NvdW50OmU5NzU2MmNmLTYyZDMtNDVmNC1hNWU5LTUwMWY1Nzk5NjFkYyJ9.zTqCtbu_yKD0vmWX4iG9rH2W81bMYORR4OvhTo4l8-g'}

    def test_complete_cms_to_chat_workflow(
        self, client, backend_service_account_headers
    ):
        """Test complete workflow from CMS content creation to chat session."""
        print("\\n Testing complete CMS to Chat workflow...")

        # 1. Create CMS content
        print("    Creating CMS content...")
        content_id = self.test_create_cms_content_with_auth(
            client, backend_service_account_headers
        )
        print(f"    Created content: {content_id}")

        # 2. Create a flow
        print("    Creating flow definition...")
        flow_id = self.test_create_flow_definition_with_auth(
            client, backend_service_account_headers
        )
        print(f"    Created flow: {flow_id}")

        # 3. Verify content is accessible
        print("    Verifying content accessibility...")
        content_response = client.get(
            "/v1/cms/content", headers=backend_service_account_headers
        )
        assert content_response.status_code == 200
        content_data = content_response.json()

        retrieved_ids = {item["id"] for item in content_data["data"]}
>       assert content_id in retrieved_ids
E       AssertionError: assert None in {'00c934dd-df6f-4921-bcd8-1868ef5f24de', '04854545-ef3e-4129-9260-d9502b18e3b7', '0592e463-f960-4675-9382-30559ef29cac', '072effaf-b63c-49b8-ac68-dbbcb5be5038', '074e38c2-f00b-4874-b06b-6429ea20e65f', '07582c8f-ee3e-43d5-b027-2ad14f290019', ...}

app/tests/integration/test_cms_authenticated.py:299: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stdout call -----------------------------
\n Testing complete CMS to Chat workflow...
    Creating CMS content...
    Created content: None
    Creating flow definition...
    Created flow: None
    Verifying content accessibility...
----------------------------- Captured stderr call -----------------------------
[info     ] Created content                [app.api.cms] content_id=UUID('18546adb-c3f7-42de-af87-f0e7358cf78d') type=joke
[info     ] Created flow                   [app.api.cms] flow_id=UUID('47a20441-4793-4f3c-8ff7-1c5c73173ae0') name=Test Programming Assessment
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': None, 'active': None} total=101
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:146 {'content_id': UUID('18546adb-c3f7-42de-af87-f0e7358cf78d'), 'type': <ContentType.JOKE: 'joke'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:391 {'flow_id': UUID('47a20441-4793-4f3c-8ff7-1c5c73173ae0'), 'name': 'Test Programming Assessment', 'event': 'Created flow', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': None, 'active': None}, 'total': 101, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
--------------------------- Captured stderr teardown ---------------------------
[info     ] Shutting down event system...  [app.events]
[info     ] Keep-alive task cancelled      [app.services.event_listener]
[info     ] Stopped listening for flow events [app.services.event_listener]
[info     ] Disconnected from PostgreSQL event listener [app.services.event_listener]
[info     ] Event system shut down successfully [app.events]
---------------------------- Captured log teardown -----------------------------
INFO     app.events:__init__.py:56 Shutting down event system...
INFO     app.services.event_listener:event_listener.py:205 Keep-alive task cancelled
INFO     app.services.event_listener:event_listener.py:192 Stopped listening for flow events
INFO     app.services.event_listener:event_listener.py:77 Disconnected from PostgreSQL event listener
INFO     app.events:__init__.py:66 Event system shut down successfully
______________ TestCMSContentPatterns.test_create_content_library ______________

self = <test_cms_content_patterns.TestCMSContentPatterns object at 0x7bca593c6990>
async_client = <httpx.AsyncClient object at 0x7bca50955fd0>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwNjksImlhdCI6MTc1NDE3MTA2OSwic3ViIjo...6c2VydmljZS1hY2NvdW50OjliZGRiYzQ1LWE5OWYtNDJkYy1hZWRmLWUwMWMxOTdlOTQ0NCJ9.KYqT2qmhzPdD5PJbSt3rR2_uxzskbRa7BmDqtVI1vWw'}
sample_content_library = [{'content': {'style': 'friendly', 'target_audience': 'general', 'text': "Welcome to Bookbot! I'm here to help you dis...'priority': 'low', 'usage': 'entertainment'}, 'tags': ['joke', 'books', 'kids', 'entertainment'], 'type': 'joke'}, ...]

    @pytest.mark.asyncio
    async def test_create_content_library(
        self, async_client, backend_service_account_headers, sample_content_library
    ):
        """Test creating a comprehensive content library."""
        created_content = []

        # Create all content items
        for content_data in sample_content_library:
            response = await async_client.post(
                "/v1/cms/content",
                json=content_data,
                headers=backend_service_account_headers
            )

            assert response.status_code == 201, f"Failed to create content: {content_data['type']}"
            created_item = response.json()
            created_content.append(created_item)

            # Verify structure
            assert created_item["type"] == content_data["type"]
            assert created_item["content"] == content_data["content"]
            assert set(created_item["tags"]) == set(content_data["tags"])
            assert created_item["is_active"] is True

        # Test querying content by categories
        category_tests = [
            ("onboarding", 2),  # Welcome messages
            ("data_collection", 3),  # Questions
            ("humor", 2),  # Jokes
            ("motivation", 1),  # Encouragement
        ]

        for category, expected_count in category_tests:
            # Search by tags related to category
            response = await async_client.get(
                "/v1/cms/content",
                params={"search": category},
                headers=backend_service_account_headers
            )

            assert response.status_code == 200
            # Note: Search behavior depends on implementation
            # This test verifies the API responds correctly

        # Test content type filtering
        content_type_tests = [
            ("message", 4),  # Message types
            ("question", 3),  # Question types
            ("joke", 2),  # Joke types
        ]

        for content_type, expected_min in content_type_tests:
            response = await async_client.get(
                "/v1/cms/content",
                params={"content_type": content_type},
                headers=backend_service_account_headers
            )

            assert response.status_code == 200
            data = response.json()
            items = data.get("data", [])

            # Filter our created content
            our_items = [item for item in items if item["id"] in [c["id"] for c in created_content]]
            type_count = len([item for item in our_items if item["type"] == content_type])

>           assert type_count == expected_min, f"Expected {expected_min} {content_type} items, got {type_count}"
E           AssertionError: Expected 4 message items, got 5
E           assert 5 == 4

app/tests/integration/test_cms_content_patterns.py:255: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stderr call -----------------------------
[info     ] Created content                [app.api.cms] content_id=UUID('a724ab2a-aadb-4218-8531-a2de3adbaabc') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('6f4ba2b8-b0b1-4f49-b04e-b84498d6f956') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('78994456-5cce-407a-bfca-93f783e286bd') type=question
[info     ] Created content                [app.api.cms] content_id=UUID('8d557b6a-7988-476d-99c5-612e1bea2b57') type=question
[info     ] Created content                [app.api.cms] content_id=UUID('f5f89928-7802-46ea-b26a-4c884d26ddfc') type=question
[info     ] Created content                [app.api.cms] content_id=UUID('c4de1146-0978-4f10-b070-6c572ad1be87') type=joke
[info     ] Created content                [app.api.cms] content_id=UUID('6fdc3c44-0e61-45b9-8e0a-2d537a4a44ed') type=joke
[info     ] Created content                [app.api.cms] content_id=UUID('5f4ba103-9b03-4a85-b818-1557df2196fb') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('fd6c089a-ec5e-4c5e-9a75-e6acf26be551') type=message
[info     ] Created content                [app.api.cms] content_id=UUID('c2f526ec-36f7-4a4f-9a71-ff1543b5b3f9') type=message
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': 'onboarding', 'active': None} total=0
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': 'data_collection', 'active': None} total=0
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': 'humor', 'active': None} total=0
[info     ] Retrieved content list         [app.api.cms] filters={'type': None, 'tags': None, 'search': 'motivation', 'active': None} total=0
[info     ] Retrieved content list         [app.api.cms] filters={'type': <ContentType.MESSAGE: 'message'>, 'tags': None, 'search': None, 'active': None} total=55
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:146 {'content_id': UUID('a724ab2a-aadb-4218-8531-a2de3adbaabc'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('6f4ba2b8-b0b1-4f49-b04e-b84498d6f956'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('78994456-5cce-407a-bfca-93f783e286bd'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('8d557b6a-7988-476d-99c5-612e1bea2b57'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('f5f89928-7802-46ea-b26a-4c884d26ddfc'), 'type': <ContentType.QUESTION: 'question'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('c4de1146-0978-4f10-b070-6c572ad1be87'), 'type': <ContentType.JOKE: 'joke'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('6fdc3c44-0e61-45b9-8e0a-2d537a4a44ed'), 'type': <ContentType.JOKE: 'joke'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('5f4ba103-9b03-4a85-b818-1557df2196fb'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('fd6c089a-ec5e-4c5e-9a75-e6acf26be551'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:146 {'content_id': UUID('c2f526ec-36f7-4a4f-9a71-ff1543b5b3f9'), 'type': <ContentType.MESSAGE: 'message'>, 'event': 'Created content', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': 'onboarding', 'active': None}, 'total': 0, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': 'data_collection', 'active': None}, 'total': 0, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': 'humor', 'active': None}, 'total': 0, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': None, 'tags': None, 'search': 'motivation', 'active': None}, 'total': 0, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
INFO     app.api.cms:cms.py:91 {'filters': {'type': <ContentType.MESSAGE: 'message'>, 'tags': None, 'search': None, 'active': None}, 'total': 55, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
______________ TestCMSAuthentication.test_content_filtering_works ______________

self = <test_cms_demo.TestCMSAuthentication object at 0x7bca593b1c90>
client = <starlette.testclient.TestClient object at 0x7bca439d4910>
backend_service_account_headers = {'Authorization': 'bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE4MTcyNDMwNzIsImlhdCI6MTc1NDE3MTA3Miwic3ViIjo...6c2VydmljZS1hY2NvdW50OjhkMzkwZDg3LWUyZTYtNDkxOC1iZWZmLTUxZDI2MzIxNWMwOSJ9.1XL_GIZ78bLwlhuEPEVfJisL5STwuSc0w8Oj3PTF4do'}

    def test_content_filtering_works(self, client, backend_service_account_headers):
        """ CMS content filtering by type works correctly."""
        # Test filtering by different content types
        for content_type in ["JOKE", "QUESTION", "MESSAGE"]:
            response = client.get(
                f"/v1/cms/content?content_type={content_type}",
                headers=backend_service_account_headers,
            )
            assert response.status_code == 200

            data = response.json()
            print(f"\\n Found {len(data['data'])} {content_type} items")

            # All returned items should match the requested type
            for item in data["data"]:
>               assert item["type"] == content_type
E               AssertionError: assert 'joke' == 'JOKE'
E
E                 - JOKE
E                 + joke

app/tests/integration/test_cms_demo.py:89: AssertionError
---------------------------- Captured stdout setup -----------------------------
Generating auth token
----------------------------- Captured stdout call -----------------------------
\n Found 13 JOKE items
----------------------------- Captured stderr call -----------------------------
[info     ] Retrieved content list         [app.api.cms] filters={'type': <ContentType.JOKE: 'joke'>, 'tags': None, 'search': None, 'active': None} total=13
------------------------------ Captured log call -------------------------------
INFO     app.api.cms:cms.py:91 {'filters': {'type': <ContentType.JOKE: 'joke'>, 'tags': None, 'search': None, 'active': None}, 'total': 13, 'event': 'Retrieved content list', 'logger': 'app.api.cms', 'level': 'info'}
_____________ TestCMSAuthentication.test_cms_content_requires_auth _____________

self = <test_cms_full_integration.TestCMSAuthentication object at 0x7bca593995d0>
async_client = <httpx.AsyncClient object at 0x7bca5044c750>

    @pytest.mark.asyncio
    async def test_cms_content_requires_auth(self, async_client):
        """Test that CMS content endpoints require authentication."""
        # Try to access CMS content without auth
        response = await async_client.get("/cms/content")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

app/tests/integration/test_cms_full_integration.py:504: AssertionError
______________ TestCMSAuthentication.test_cms_flows_requires_auth ______________

self = <test_cms_full_integration.TestCMSAuthentication object at 0x7bca593a0950>
async_client = <httpx.AsyncClient object at 0x7bca50f44b50>

    @pytest.mark.asyncio
    async def test_cms_flows_requires_auth(self, async_client):
        """Test that CMS flow endpoints require authentication."""
        # Try to access flows without auth
        response = await async_client.get("/cms/flows")
>       assert response.status_code == 401
E       assert 404 == 401
E        +  where 404 = <Response [404 Not Found]>.status_code

app/tests/integration/test_cms_full_integration.py:515: AssertionError
_________ TestCMSAuthentication.test_chat_start_does_not_require_auth __________

self = <test_cms_full_integration.TestCMSAuthentication object at 0x7bca593a1890>
async_client = <httpx.AsyncClient object at 0x7bca506a6090>

    @pytest.mark.asyncio
    async def test_chat_start_does_not_require_auth(self, async_client):
        """Test that chat start endpoint does not require authentication."""
        # This should fail for other reasons (invalid flow), but not auth
        response = await async_client.post(
            "/chat/start",
            json={"flow_id": str(uuid4()), "user_id": None, "initial_state": {}},
        )

        # Should not be 401 (auth error), but 400 (flow not found)
        assert response.status_code != 401
>       assert response.status_code == 400
E       assert 404 == 400
E        +  where 404 = <Response [404 Not Found]>.status_code

app/tests/integration/test_cms_full_integration.py:532: AssertionError
________________ TestVariableResolver.test_variable_validation _________________

self = <test_variable_resolver.TestVariableResolver object at 0x7bca5930b010>
variable_resolver = <app.services.variable_resolver.VariableResolver object at 0x7bca43757490>

    def test_variable_validation(self, variable_resolver):
        """Test variable validation functionality."""
        # Test valid variables
        valid_vars = ["{{user.name}}", "{{context.locale}}", "{{temp.current_step}}"]
        for var in valid_vars:
            errors = variable_resolver.validate_variable_references(var)
            assert len(errors) == 0

        # Test invalid variables (if validation is implemented)
        invalid_vars = ["{{nonexistent.field}}", "{{user.missing.path}}"]
        for var in invalid_vars:
            errors = variable_resolver.validate_variable_references(var)
            # Should have validation errors for missing variables
>           assert len(errors) > 0
E           assert 0 > 0
E            +  where 0 = len([])

app/tests/integration/test_variable_resolver.py:239: AssertionError
=============================== warnings summary ===============================
../home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic_core/core_schema.py:4324
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic_core/core_schema.py:4324: DeprecationWarning: `FieldValidationInfo` is deprecated, use `ValidationInfo` instead.
    warnings.warn(msg, DeprecationWarning, stacklevel=1)

app/schemas/sendgrid.py:47
  /app/app/schemas/sendgrid.py:47: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    @validator("template_data", always=True)

../home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/_migration.py:283
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/_migration.py:283: UserWarning: `pydantic.error_wrappers:ValidationError` has been moved to `pydantic:ValidationError`.
    warnings.warn(f'`{import_path}` has been moved to `{new_location}`.')

app/tests/integration/test_advanced_node_processors.py::TestActionNodeProcessor::test_action_failure_handling
app/tests/integration/test_advanced_node_processors.py::TestActionNodeProcessor::test_missing_action_type
app/tests/integration/test_advanced_node_processors.py::TestWebhookNodeProcessor::test_webhook_failure_with_fallback
app/tests/integration/test_advanced_node_processors.py::TestWebhookNodeProcessor::test_webhook_missing_url
app/tests/integration/test_advanced_node_processors.py::TestCompositeNodeProcessor::test_composite_child_failure
app/tests/integration/test_advanced_node_processors.py::TestConditionNodeProcessor::test_logical_and_condition
app/tests/integration/test_advanced_node_processors.py::TestConditionNodeProcessor::test_logical_or_condition
app/tests/integration/test_commerce_api.py::test_stripe_webhook_validates_signature
  /home/wriveted/poetry-env/lib/python3.11/site-packages/structlog/stdlib.py:1098: UserWarning: Remove `format_exc_info` from your processor chain if you want pretty exceptions.
    ed = p(logger, meth_name, cast(EventDict, ed))

app/tests/integration/test_api.py: 7 warnings
app/tests/integration/test_booklist_api.py: 3 warnings
app/tests/integration/test_class_code_login.py: 6 warnings
app/tests/integration/test_collection_updates.py: 25 warnings
app/tests/integration/test_dashboard_embed.py: 2 warnings
app/tests/integration/test_events_api.py: 4 warnings
app/tests/integration/test_school_crud.py: 4 warnings
app/tests/integration/test_user_api.py: 4 warnings
app/tests/integration/test_user_crud.py: 11 warnings
app/tests/integration/test_user_service.py: 2 warnings
app/tests/integration/test_work_api.py: 2 warnings
  /home/wriveted/poetry-env/lib/python3.11/site-packages/starlette/testclient.py:431: DeprecationWarning: You should not use the 'timeout' argument with the TestClient. See https://github.com/encode/starlette/issues/1108 for more information.
    warnings.warn(

app/tests/integration/test_api.py: 5 warnings
app/tests/integration/test_booklist_api.py: 9 warnings
app/tests/integration/test_cms.py: 2 warnings
app/tests/integration/test_cms_content_patterns.py: 1 warning
app/tests/integration/test_collection_api.py: 5 warnings
app/tests/integration/test_collection_updates.py: 7 warnings
app/tests/integration/test_work_api.py: 2 warnings
  /app/app/crud/base.py:230: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    update_data = obj_in.dict(exclude_unset=True)

app/tests/integration/test_async_task_idempotency.py::test_acquire_idempotency_lock_duplicate
  sys:1: SAWarning: New instance <IdempotencyRecord at 0x7bca52168e50> with identity key (<class 'app.models.cms.IdempotencyRecord'>, ('test_session_evspemvpxi:test_node:1',), None) conflicts with persistent instance <IdempotencyRecord at 0x7bca52169410>

app/tests/integration/test_async_task_idempotency.py::test_concurrent_task_processing
  /app/app/crud/chat_repo.py:338: SAWarning: Usage of the 'Session.add()' operation is not currently supported within the execution stage of the flush process. Results may not be consistent.  Consider using alternative event listeners or connection-level operations instead.
    db.add(record)

app/tests/integration/test_async_task_idempotency.py::test_concurrent_task_processing
  sys:1: SAWarning: New instance <IdempotencyRecord at 0x7bca5203c910> with identity key (<class 'app.models.cms.IdempotencyRecord'>, ('55c439d9-3fad-4bd0-a31e-83fb34614bf1:zvmqxshurz:test_node:1',), None) conflicts with persistent instance <IdempotencyRecord at 0x7bca52289bd0>

app/tests/integration/test_async_task_idempotency.py::test_concurrent_task_processing
  sys:1: SAWarning: New instance <IdempotencyRecord at 0x7bca538b1d10> with identity key (<class 'app.models.cms.IdempotencyRecord'>, ('55c439d9-3fad-4bd0-a31e-83fb34614bf1:zvmqxshurz:test_node:1',), None) conflicts with persistent instance <IdempotencyRecord at 0x7bca52289bd0>

app/tests/integration/test_booklist_api.py: 29 warnings
  /app/app/services/booklists.py:226: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    new_data_dict = new_data.dict(exclude_unset=True)

app/tests/integration/test_booklist_api.py::test_create_empty_booklist
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=UUID('1dc81037-966d-4876-b0a0-a191037e4f44'), input_type=UUID])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py: 2100 warnings
app/tests/integration/test_booklist_service.py: 100 warnings
app/tests/integration/test_editions_api.py: 200 warnings
app/tests/integration/test_work_api.py: 1100 warnings
  /app/app/crud/edition.py:85: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    info=edition_data.info.dict() if edition_data.info else {},

app/tests/integration/test_booklist_api.py::test_school_admin_can_create_school_booklist
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=8, input_type=int])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py: 850 warnings
  /app/app/crud/booklist.py:66: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    action=ItemUpdateType.ADD, **item.dict()

app/tests/integration/test_booklist_api.py::test_user_account_can_create_personal_booklist
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=UUID('ee49349d-ae9c-47a1-aebb-8a1f380dde33'), input_type=UUID])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py::test_anyone_can_create_personal_booklist
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=UUID('30f5c2d2-c03b-407f-8bf8-7d635a455bf8'), input_type=UUID])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py::test_create_school_booklist_without_positions
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=9, input_type=int])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py::test_create_booklist_with_item_info
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=UUID('531b3603-12f9-450b-bc58-409234a6b89a'), input_type=UUID])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py: 160 warnings
  /app/app/crud/booklist.py:312: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    info=item_update.info.dict() if item_update.info is not None else None,

app/tests/integration/test_booklist_api.py::test_rename_personal_booklist
  /home/wriveted/poetry-env/lib/python3.11/site-packages/pydantic/main.py:463: UserWarning: Pydantic serializer warnings:
    PydanticSerializationUnexpectedValue(Expected `str` - serialized value may not be as expected [input_value=UUID('8f945d50-b99c-46d3-9ec2-e60ce3b04a76'), input_type=UUID])
    return self.__pydantic_serializer__.to_python(

app/tests/integration/test_booklist_api.py::test_change_booklist_type
  /app/app/crud/booklist.py:151: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    if obj_in.info and "image_url" in obj_in.info.dict(exclude_unset=True):

app/tests/integration/test_booklist_service.py: 20 warnings
  /app/app/crud/booklist.py:112: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    action=ItemUpdateType.ADD, **item.dict()

app/tests/integration/test_booklist_service.py: 20 warnings
  /app/app/crud/booklist.py:356: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    info=item_update.info.dict() if item_update.info is not None else None,

app/tests/integration/test_booklist_service.py::test_read_now_read_next_generation
  /app/app/services/booklists.py:137: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    "attributes": attributes.dict(),

app/tests/integration/test_chat_api.py::test_start_conversation
  /home/wriveted/poetry-env/lib/python3.11/site-packages/_pytest/python.py:161: PytestReturnNotNoneWarning: Test functions should return None, but app/tests/integration/test_chat_api.py::test_start_conversation returned <class 'tuple'>.
  Did you mean to use `assert` instead of `return`?
  See https://docs.pytest.org/en/stable/how-to/assert.html#return-not-none for more information.
    warnings.warn(

app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_recovery_to_closed
  /app/app/tests/integration/test_circuit_breaker.py:154: RuntimeWarning: coroutine 'TestCircuitBreaker.test_circuit_breaker_recovery_to_closed.<locals>.sometimes_failing_func' was never awaited
    await circuit_breaker.call(lambda: sometimes_failing_func(True))
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_stats_tracking
  /app/app/tests/integration/test_circuit_breaker.py:202: RuntimeWarning: coroutine 'TestCircuitBreaker.test_circuit_breaker_stats_tracking.<locals>.mixed_func' was never awaited
    await circuit_breaker.call(lambda: mixed_func(False))  # Success
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_stats_tracking
  /app/app/tests/integration/test_circuit_breaker.py:204: RuntimeWarning: coroutine 'TestCircuitBreaker.test_circuit_breaker_stats_tracking.<locals>.mixed_func' was never awaited
    await circuit_breaker.call(lambda: mixed_func(True))  # Failure
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/integration/test_circuit_breaker.py::TestCircuitBreakerRegistry::test_registry_get_all_stats
app/tests/integration/test_circuit_breaker.py::TestCircuitBreakerRegistry::test_registry_get_all_stats
  /app/app/services/circuit_breaker.py:218: PydanticDeprecatedSince20: The `copy` method is deprecated; use `model_copy` instead. See the docstring of `BaseModel.copy` for details about how to handle `include` and `exclude`. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    return self.stats.copy()

app/tests/integration/test_cms.py::test_update_variant_performance
  /app/app/api/cms.py:324: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    performance_data=performance_data.dict(exclude_unset=True),

app/tests/integration/test_cms_demo.py::TestSystemHealth::test_comprehensive_system_demo
  /usr/local/lib/python3.11/weakref.py:414: RuntimeWarning: coroutine 'TestCircuitBreaker.test_circuit_breaker_concurrent_access.<locals>.slow_func' was never awaited
    def __getitem__(self, key):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/integration/test_cms_demo.py::TestSystemHealth::test_comprehensive_system_demo
  /usr/local/lib/python3.11/weakref.py:414: RuntimeWarning: coroutine 'TestCircuitBreakerIntegration.test_circuit_breaker_recovery_simulation.<locals>.api_call' was never awaited
    def __getitem__(self, key):
  Enable tracemalloc to get traceback where the object was allocated.
  See https://docs.pytest.org/en/stable/how-to/capture-warnings.html#resource-warnings for more info.

app/tests/integration/test_editions_api.py::test_update_edition_work
app/tests/integration/test_editions_api.py::test_update_edition_work
app/tests/integration/test_editions_api.py::test_update_edition_details
app/tests/integration/test_editions_api.py::test_update_edition_details
app/tests/integration/test_work_api.py::test_move_edition_to_existing_work
  /app/app/api/editions.py:126: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    update_data = edition_data.dict(exclude_unset=True)

app/tests/integration/test_editions_api.py::test_update_edition_work
app/tests/integration/test_editions_api.py::test_update_edition_work
app/tests/integration/test_editions_api.py::test_update_edition_details
app/tests/integration/test_editions_api.py::test_update_edition_details
app/tests/integration/test_work_api.py::test_move_edition_to_existing_work
  /app/app/api/editions.py:165: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    changes_dict = edition_data.dict(exclude_unset=True, exclude_defaults=True)

app/tests/integration/test_editions_api.py::test_update_edition_details
  /app/app/tests/integration/test_editions_api.py:56: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    json=edition_update_with_new_title_and_info.dict(exclude_unset=True),

app/tests/integration/test_editions_api.py::test_update_edition_details
  /app/app/tests/integration/test_editions_api.py:68: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    to_merge_payload = edition_update_with_info_to_merge.dict(exclude_unset=True)

app/tests/integration/test_user_api.py::test_update_public_user_to_student_type
app/tests/integration/test_user_api.py::test_update_public_user_to_student_type
app/tests/integration/test_user_api.py::test_update_student_to_public_reader
  /app/app/api/users.py:133: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    updated_items = user_update.dict(exclude_unset=True)

app/tests/integration/test_user_api.py::test_update_public_user_to_student_type
app/tests/integration/test_user_api.py::test_update_student_to_public_reader
  /app/app/api/users.py:134: UserWarning: A custom validator is returning a value other than `self`.
  Returning anything other than `self` from a top level model validator isn't supported when validating via `__init__`.
  See the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.
    update_data = InternalUserUpdateIn(current_type=user.type, **updated_items)

app/tests/integration/test_user_api.py::test_update_public_user_to_student_type
app/tests/integration/test_user_api.py::test_update_student_to_public_reader
app/tests/integration/test_user_crud.py::test_cross_model_updates
app/tests/integration/test_user_crud.py::test_user_info_dict_merging
app/tests/integration/test_user_crud.py::test_user_info_dict_merging
app/tests/integration/test_user_crud.py::test_public_reader_to_student_update
app/tests/integration/test_user_crud.py::test_student_to_public_reader_update
app/tests/integration/test_user_crud.py::test_student_to_public_reader_update
  /app/app/crud/user.py:137: PydanticDeprecatedSince20: The `dict` method is deprecated; use `model_dump` instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.11/migration/
    update_data = obj_in.dict(exclude_unset=True)

app/tests/integration/test_user_api.py::test_update_public_user_to_student_type
  /app/app/tests/integration/test_user_api.py:60: SAWarning: DELETE statement on table 'public_readers' expected to delete 1 row(s); 0 were matched.  Please set confirm_deleted_rows=False within the mapper configuration to prevent this warning.
    session.commit()

app/tests/integration/test_user_crud.py::test_public_reader_to_student_update
  /app/app/tests/integration/test_user_crud.py:221: UserWarning: A custom validator is returning a value other than `self`.
  Returning anything other than `self` from a top level model validator isn't supported when validating via `__init__`.
  See the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.
    obj_in=InternalUserUpdateIn(

app/tests/integration/test_user_crud.py::test_student_to_public_reader_update
  /app/app/crud/base.py:151: SAWarning: DELETE statement on table 'public_readers' expected to delete 1 row(s); 0 were matched.  Please set confirm_deleted_rows=False within the mapper configuration to prevent this warning.
    db.commit()

app/tests/integration/test_user_crud.py::test_student_to_public_reader_update
  /app/app/tests/integration/test_user_crud.py:242: UserWarning: A custom validator is returning a value other than `self`.
  Returning anything other than `self` from a top level model validator isn't supported when validating via `__init__`.
  See the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.
    obj_in=InternalUserUpdateIn(

app/tests/integration/test_user_crud.py::test_student_to_public_reader_update
  /app/app/tests/integration/test_user_crud.py:259: UserWarning: A custom validator is returning a value other than `self`.
  Returning anything other than `self` from a top level model validator isn't supported when validating via `__init__`.
  See the `model_validator` docs (https://docs.pydantic.dev/latest/concepts/validators/#model-validators) for more details.
    obj_in=InternalUserUpdateIn(

../home/wriveted/poetry-env/lib/python3.11/site-packages/_pytest/cacheprovider.py:475
  /home/wriveted/poetry-env/lib/python3.11/site-packages/_pytest/cacheprovider.py:475: PytestCacheWarning: could not create cache path /app/.pytest_cache/v/cache/nodeids: [Errno 13] Permission denied: '/app/pytest-cache-files-2dk11tvw'
    config.cache.set("cache/nodeids", sorted(self.cached_nodeids))

../home/wriveted/poetry-env/lib/python3.11/site-packages/_pytest/cacheprovider.py:429
  /home/wriveted/poetry-env/lib/python3.11/site-packages/_pytest/cacheprovider.py:429: PytestCacheWarning: could not create cache path /app/.pytest_cache/v/cache/lastfailed: [Errno 13] Permission denied: '/app/pytest-cache-files-ef0_zoni'
    config.cache.set("cache/lastfailed", self.lastfailed)

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html

---------- coverage: platform linux, python 3.11.13-final-0 ----------

=========================== short test summary info ============================
FAILED app/tests/integration/test_booklist_service.py::test_read_now_read_next_generation
FAILED app/tests/integration/test_chat_api.py::test_interact_with_session_csrf_protected
FAILED app/tests/integration/test_chat_api.py::test_interact_without_csrf_token
FAILED app/tests/integration/test_chat_api.py::test_interact_with_invalid_csrf_token
FAILED app/tests/integration/test_chat_api.py::test_update_session_state - as...
FAILED app/tests/integration/test_chat_api.py::test_update_session_state_with_concurrency_conflict
FAILED app/tests/integration/test_chat_api.py::test_end_session - AssertionEr...
FAILED app/tests/integration/test_chat_api.py::test_session_timeout_handling
FAILED app/tests/integration/test_chat_api.py::test_rate_limiting_protection
FAILED app/tests/integration/test_chat_api_scenarios.py::TestChatAPIScenarios::test_automated_bookbot_conversation
FAILED app/tests/integration/test_chat_api_scenarios.py::TestChatAPIScenarios::test_conversation_end_session
FAILED app/tests/integration/test_chat_api_scenarios.py::TestChatAPIScenarios::test_multiple_concurrent_sessions
FAILED app/tests/integration/test_chat_api_scenarios.py::TestChatAPIScenarios::test_variable_substitution_in_messages
FAILED app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_recovery_to_closed
FAILED app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_stats_tracking
FAILED app/tests/integration/test_circuit_breaker.py::TestCircuitBreaker::test_circuit_breaker_concurrent_access
FAILED app/tests/integration/test_circuit_breaker.py::TestCircuitBreakerIntegration::test_circuit_breaker_with_webhook_simulation
FAILED app/tests/integration/test_circuit_breaker.py::TestCircuitBreakerIntegration::test_circuit_breaker_recovery_simulation
FAILED app/tests/integration/test_cms_api_enhanced.py::TestCMSAPIEnhanced::test_content_filtering_comprehensive
FAILED app/tests/integration/test_cms_api_enhanced.py::TestCMSAPIEnhanced::test_content_creation_comprehensive
FAILED app/tests/integration/test_cms_api_enhanced.py::TestCMSAPIEnhanced::test_flow_creation_comprehensive
FAILED app/tests/integration/test_cms_api_enhanced.py::TestCMSAPIEnhanced::test_cms_pagination
FAILED app/tests/integration/test_cms_authenticated.py::TestCMSWithAuthentication::test_chat_start_does_not_require_auth
FAILED app/tests/integration/test_cms_authenticated.py::TestCMSWithAuthentication::test_get_flow_nodes_with_auth
FAILED app/tests/integration/test_cms_authenticated.py::TestCMSWithAuthentication::test_start_chat_session_with_created_flow
FAILED app/tests/integration/test_cms_authenticated.py::TestCMSWithAuthentication::test_complete_cms_to_chat_workflow
FAILED app/tests/integration/test_cms_content_patterns.py::TestCMSContentPatterns::test_create_content_library
FAILED app/tests/integration/test_cms_demo.py::TestCMSAuthentication::test_content_filtering_works
FAILED app/tests/integration/test_cms_full_integration.py::TestCMSAuthentication::test_cms_content_requires_auth
FAILED app/tests/integration/test_cms_full_integration.py::TestCMSAuthentication::test_cms_flows_requires_auth
FAILED app/tests/integration/test_cms_full_integration.py::TestCMSAuthentication::test_chat_start_does_not_require_auth
FAILED app/tests/integration/test_variable_resolver.py::TestVariableResolver::test_variable_validation
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_create_cms_content_joke
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_create_cms_content_question
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_create_cms_content_message
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_list_cms_content
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_filter_cms_content_by_type
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_get_specific_cms_content
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSContentAPI::test_update_cms_content
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSFlowAPI::test_create_flow_definition
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSFlowAPI::test_list_flows
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSFlowAPI::test_get_specific_flow
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSFlowAPI::test_get_flow_nodes
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSFlowAPI::test_get_flow_connections
ERROR app/tests/integration/test_cms_full_integration.py::TestChatAPI::test_start_chat_session_with_published_flow
ERROR app/tests/integration/test_cms_full_integration.py::TestChatAPI::test_get_session_state
ERROR app/tests/integration/test_cms_full_integration.py::TestChatAPI::test_chat_session_with_unpublished_flow_fails
ERROR app/tests/integration/test_cms_full_integration.py::TestCMSIntegrationWorkflow::test_complete_cms_to_chat_workflow
===== 32 failed, 284 passed, 4745 warnings, 16 errors in 215.37s (0:03:35) =====